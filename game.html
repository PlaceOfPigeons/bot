<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Image Catcher</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWwSObNeCTqDk8xJg9sa0u4wIvk5JFw8E",
            authDomain: "placeofpigeons.firebaseapp.com",
            databaseURL: "https://placeofpigeons-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "placeofpigeons",
            storageBucket: "placeofpigeons.appspot.com",
            messagingSenderId: "67354529384",
            appId: "1:67354529384:web:716cf99397eb9002c435dd",
            measurementId: "G-P70KRENL94"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let userId = "7380238976";  // Например, ID пользователя, который будет использоваться для поиска
        let storedScore = 0; // Изначально очки равны нулю
        let score = storedScore;

        const game = document.getElementById('game');
        const scoreDisplay = document.getElementById('score').querySelector('span');
        const sequenceDisplay = document.getElementById('sequence');
        const timerDisplay = document.getElementById('timer');
        const birds = ['birdOne.png', 'birdTwo.png', 'birdThree.png'];

        let currentSequence = [];
        let userSequence = [];
        let lastClickX = 0;
        let lastClickY = 0;
        const birdWidth = 96;
        const screenWidth = window.innerWidth;
        const maxLeft = screenWidth - birdWidth;

        let timerValue = 60;

        // Загрузка очков из Firebase
        function loadScoreFromFirebase() {
            const scoreRef = ref(database, 'scores/' + userId);
            get(scoreRef).then((snapshot) => {
                if (snapshot.exists()) {
                    storedScore = snapshot.val();
                    score = storedScore;
                } else {
                    console.log("No data available");
                    score = 0;
                }
                updateScoreDisplay(score); // Обновляем отображение очков
            }).catch((error) => {
                console.error("Error getting score: ", error);
            });
        }

        // Сохранение очков в Firebase
        function saveScoreToFirebase() {
            set(ref(database, 'scores/' + userId), {
                score: score
            }).then(() => {
                console.log("Score saved successfully!");
            }).catch((error) => {
                console.error("Error saving score: ", error);
            });
        }

        // Функция для создания последовательности
        function createSequence() {
            currentSequence = [];
            for (let i = 0; i < 3; i++) {
                currentSequence.push(birds[Math.floor(Math.random() * birds.length)]);
            }
            sequenceDisplay.innerHTML = currentSequence.map(img => `<img src="${img}" style="width: 72px; height: 72px; object-fit: contain;">`).join(' ');
            userSequence = [];
        }

        // Функция для создания птицы
        function createBird() {
            const bird = document.createElement('img');
            bird.classList.add('bird');
            bird.src = birds[Math.floor(Math.random() * birds.length)];

            const cage = document.createElement('div');
            cage.classList.add('cage');

            const wrapper = document.createElement('div');
            wrapper.classList.add('wrapper');
            wrapper.style.left = `${Math.random() * maxLeft}px`;

            wrapper.appendChild(cage);
            wrapper.appendChild(bird);
            game.appendChild(wrapper);

            let isCageClicked = false;
            let isBirdClicked = false;

            cage.addEventListener('click', () => {
                if (isCageClicked) return;
                isCageClicked = true;
                cage.style.display = 'none';
            });

            bird.addEventListener('click', (event) => {
                if (!isCageClicked || isBirdClicked) return;

                isBirdClicked = true;

                lastClickX = event.clientX;
                lastClickY = event.clientY;

                userSequence.push(bird.src.split('/').pop());

                if (userSequence.length === 3 && userSequence.join(',') === currentSequence.join(',')) {
                    score += 10;

                    const pointAnim = document.createElement('div');
                    pointAnim.classList.add('points', 'plus10');
                    pointAnim.textContent = "+10";
                    pointAnim.style.left = `${lastClickX}px`;
                    pointAnim.style.top = `${lastClickY}px`;
                    game.appendChild(pointAnim);

                    setTimeout(() => pointAnim.remove(), 1000);

                    updateScoreDisplay(score);
                    createSequence();

                } else if (userSequence.length < 3) {
                    score++;
                    updateScoreDisplay(score);

                    const pointAnim = document.createElement('div');
                    pointAnim.classList.add('points');
                    pointAnim.textContent = "+1";
                    pointAnim.style.left = `${lastClickX}px`;
                    pointAnim.style.top = `${lastClickY}px`;
                    game.appendChild(pointAnim);

                    setTimeout(() => pointAnim.remove(), 1000);
                }

                bird.classList.add('clicked');
                setTimeout(() => {
                    wrapper.remove();
                }, 300);

                checkSequence();

                bird.blur();
                bird.setAttribute('tabindex', '-1');
            });

            wrapper.addEventListener('animationend', () => {
                if (!isCageClicked) {
                    wrapper.remove();
                }
            });
        }

        // Функция для обновления отображения очков
        function updateScoreDisplay(newScore) {
            scoreDisplay.textContent = `${newScore}`;
        }

        // Проверка на правильность последовательности
        function checkSequence() {
            let correctSequence = currentSequence.slice(0, userSequence.length);
            if (userSequence.join(',') !== correctSequence.join(',')) {
                userSequence = [];
            }
        }

        // Запуск таймера
        function startTimer() {
            const timerInterval = setInterval(() => {
                timerValue--;
                timerDisplay.textContent = timerValue;

                if (timerValue <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        // Завершение игры
        function endGame() {
            saveScoreToFirebase();  // Сохраняем очки в Firebase
            window.location.href = `newpage3.html?score=${score}`;
        }

        // Запуск игры
        function startGame() {
            loadScoreFromFirebase();  // Загружаем очки из Firebase
            createSequence();
            startTimer();
            setInterval(createBird, 1000);
        }

        document.addEventListener('dblclick', (event) => {
            event.preventDefault();
        });

        updateScoreDisplay(score);
        startGame();
    </script>
</head>
<body>
    <div id="game">
        <div id="score">
            <img src="tonicon3.png" alt="Очки">
            <span>0</span>
        </div>
        <div id="timer">60</div>
        <div id="sequence"></div>
    </div>
</body>
</html>
