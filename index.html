<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: white;
            color: black;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            font-size: 24px;
        }
        button {
            background-color: black;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: grey;
        }
    </style>
</head>
<body>
    <h1>Telegram Web App</h1>
    <p id="userInfo">Загрузка данных пользователя...</p> <!-- Место для отображения данных пользователя -->
    <p>Эта страница интегрирована с Telegram Web App API.</p>
    <button id="sendPoints">Send Points</button>

    <script>
        const tg = window.Telegram.WebApp;

        // Инициализация Telegram Web App
        tg.ready();

        // Функция для получения данных пользователя и отображения их на странице
        async function fetchUserData() {
            const userName = tg.initDataUnsafe?.user?.username || "Неизвестно";
            const userId = tg.initDataUnsafe?.user?.id || "Неизвестно";
            let userPoints = 0;

            try {
                // Получаем данные для валидации
                const validateResponse = await fetch(`https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com/validate`, {  
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    }),
                });

                const validateData = await validateResponse.json();

                if (validateData.message === "Validation successful") {
                    // Если валидация успешна, получаем очки
                    const pointsResponse = await fetch(`https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com/submit_points`, {  
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            points: 0  // Пример с нулевыми очками, чтобы получить текущие
                        }),
                    });

                    const pointsData = await pointsResponse.json();

                    if (pointsData.message === "Points submitted successfully") {
                        userPoints = pointsData.points;  // Обновляем очки пользователя
                    } else {
                        console.error("Ошибка при получении очков");
                    }
                } else {
                    console.error("Ошибка валидации");
                }
            } catch (error) {
                console.error("Ошибка при запросе:", error);
            }

            // Обновляем отображение данных о пользователе
            document.getElementById('userInfo').innerHTML = `
                <strong>Имя пользователя:</strong> ${userName}<br>
                <strong>ID пользователя:</strong> ${userId}<br>
                <strong>Очки:</strong> ${userPoints}<br>
            `;
        }

        // Вызов функции для получения данных
        fetchUserData();

        // Обработчик нажатия на кнопку
        document.getElementById('sendPoints').addEventListener('click', async () => {
            const points = 100;  // Очки для отправки

            try {
                // Отправляем данные на сервер для сохранения очков
                const response = await fetch("https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com/submit_points", {  
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        points: points,
                    }),
                });

                const data = await response.json();

                if (data.error) {
                    alert(`Ошибка: ${data.error}`);
                } else {
                    alert("Очки успешно отправлены!");
                    // После отправки обновляем информацию на странице
                    fetchUserData();  // Обновляем данные пользователя
                }
            } catch (error) {
                console.error("Ошибка:", error);
                alert("Произошла ошибка при отправке очков.");
            }
        });
    </script>
</body>
</html>
