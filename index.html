<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: white;
            color: black;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            font-size: 24px;
        }
        button {
            background-color: black;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: grey;
        }
    </style>
</head>
<body>
    <h1>Telegram Web App</h1>
    <p id="userInfo">Загрузка данных пользователя...</p> <!-- Место для отображения данных пользователя -->
    <p>Эта страница интегрирована с Telegram Web App API.</p>
    <button id="sendPoints">Send Points</button>

    <script>
        const tg = window.Telegram.WebApp;

        // Инициализация Telegram Web App
        tg.ready();

        // Функция для получения данных пользователя и отображения их на странице
        function fetchUserData() {
            const userName = tg.initDataUnsafe?.user?.username || "Неизвестно";
            const userId = tg.initDataUnsafe?.user?.id || "Неизвестно";
            let userPoints = 0;

            // Получаем очки с сервера
            fetch(`https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com/validate`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    initData: tg.initData
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Validation successful") {
                    fetch(`https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com/submit_points`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            points: 0  // Проверка, например, с нулевыми очками
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === "Points submitted successfully") {
                            userPoints = data.points;  // Пример обновления
                        }
                    })
                }
            })
            // Обновляем отображение данных о пользователе
            document.getElementById('userInfo').innerHTML = `
                <strong>Имя пользователя:</strong> ${userName}<br>
                <strong>ID пользователя:</strong> ${userId}<br>
                <strong>Очки:</strong> ${userPoints}<br>
            `;
        }

        // Вызов функции для получения данных
        fetchUserData();

        // Обработчик нажатия на кнопку
        document.getElementById('sendPoints').addEventListener('click', () => {
            const points = 100;  // Очки для отправки

            // Отправляем данные на сервер для сохранения очков
            fetch("https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com/submit_points", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    initData: tg.initData,
                    points: points,
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Ошибка: ${data.error}`);
                    } else {
                        alert("Очки успешно отправлены!");
                        // После отправки обновляем информацию на странице
                        fetchUserData();  // Обновляем данные пользователя
                    }
                })
                .catch(error => {
                    console.error("Ошибка:", error);
                });
        });
    </script>
</body>
</html>
